<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
    <link rel="icon" type="image/png" href="../assets/img/favicon.png">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <title>
        ASP.NET Core seeding the database
    </title>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
    
    <!--     Fonts and icons     -->
    <link rel="stylesheet" 
        type="text/css" 
        href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
    
    <link rel="stylesheet" 
        href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" 
        integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" 
        crossorigin="anonymous">

    <!-- Code highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/vs2015.min.css">

    <!-- CSS Files -->
    <link href="../assets/css/material-kit.css?v=2.0.5" rel="stylesheet" />
    <link href="../assets/css/main.css" rel="stylesheet" />
</head>
<body class="profile-page sidebar-collapse">
        <nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
        <div class="container">
            <div class="navbar-translate">
                <a class="navbar-brand" href="/">
                    I'm Johan
                </a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="navbar-toggler-icon"></span>
                    <span class="navbar-toggler-icon"></span>
                    <span class="navbar-toggler-icon"></span>
                </button>
            </div>
        <div class="collapse navbar-collapse">
            <ul class="navbar-nav ml-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="/posts/index.html">
                                <i class="fa fa-blog"></i>
                                Blog
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/about">
                                <i class="fa fa-user"></i>
                                About Me
                            </a>
                        </li>
                <li class="nav-item">
                    <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://github.com/johanvergeer" target="_blank" data-original-title="Follow me on GitHub">
                        <i class="fab fa-github fa-2x"></i>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" rel="tooltip" title="" data-placement="bottom" href="https://www.linkedin.com/in/johanvergeer" target="_blank" data-original-title="Join my network on">
                        <i class="fab fa-linkedin fa-2x"></i>
                    </a>
                </li>
            </ul>
        </div>
        </div>
    </nav>

    <div class="page-header header-filter" 
    style='background-image: url("../assets/img/city-profile.jpg"); transform: translate3d(0px, 0px, 0px);' 
    data-parallax="true">
</div>

<div class="main main-raised">
    <div class="section section-basic">
        <div class="container">
                  


<div class="title">
    <h1>ASP.NET Core seeding the database</h1>
</div>

<div class="row mb-1">
    <div class="col">
        

<span class="mr-3"><i class="fa fa-user"></i> Johan Vergeer</span>
<span><i class="fa fa-calendar"></i> <time datetime="YYYY-03-DD">Sunday, March 31, 2019</time></span>
    </div>    
</div>
<div class="row mb-1">
    <div class="col">
        

<i class="fas fa-tags"></i> 



<a href="/tags/Csharp" class="badge badge-pill badge-lg badge-primary">
    Csharp
</a>


<a href="/tags/ASPNET-Core" class="badge badge-pill badge-lg badge-primary">
    ASP.NET Core
</a>
    </div>   
</div>
<div class="row">
    <div class="col">
        <a href="/posts">Back To posts <i class="fas fa-chevron-right"></i><i class="fas fa-chevron-right"></i></a>
    </div>
</div>

<hr>

<p>It can be useful to seed the database with initial data. In this post we'll take a look at one way of achieving this.</p>
<h2 id="domain-model">Domain model</h2>
<p>In this example we'll use a simple domain model.</p>
<pre><code class="language-csharp">class Person
{
    public string FirstName { get; set; }
    public string LastName { get; set; }
    public int Age { get; set; }
}
</code></pre>
<h2 id="dbcontext">DbContext</h2>
<p>Before seeding the database we have to let <code>DbContext</code> know about our <code>Person</code> model.</p>
<div class='box box-note'>
<p>This post won't go into any detail about <code>DbContext</code>. If you would like to have more information you can read about it on <a href="https://docs.microsoft.com/en-us/ef/core/miscellaneous/configuring-dbcontext">Microsoft Docs about Configuring a DbContext</a></p>
</div>
<p>This is a very simple <code>DbContext</code> implementation for this example.</p>
<pre><code class="language-csharp">public class MyDbContext : DbContext
{
    public MyDbContext() : base()
    {
    }

    public MyDbContext(DbContextOptions options) : base(options)
    {
    }

    public virtual DbSet&lt;Person&gt; People { get; set; }

    protected override void OnModelCreating(ModelBuilder modelBuilder)
    {
        modelBuilder.Entity&lt;Person&gt;().ToTable(&quot;People&quot;);
    }
}
</code></pre>
<h2 id="connection-string-and-building-the-database">Connection string and building the database</h2>
<p>Without going into too much detail, I'll show you how to setup the connection string and build the database.</p>
<p>First you need to set the connection string in <code>appsettings.json</code>.</p>
<pre><code class="language-json">&quot;ConnectionStrings&quot;: {
    &quot;DefaultConnection&quot;:  &quot;Server=(localdb)\\mssqllocaldb;Database=MyDatabase;Trusted_Connection=True;MultipleActiveResultSets=true&quot; 
} 
</code></pre>
<p>Next you need to add <code>MyDbContext</code> to the <code>ConfigureServices()</code> method of the <code>Startup()</code> class.</p>
<pre><code class="language-csharp">public void ConfigureServices(IServiceCollection services)
{
    // Get the connection string from appsettings.json
    var connection = Configuration.GetConnectionString(&quot;DefaultConnection&quot;) ?? &quot;testingconnection&quot;;

    // Add MyDbContext to the service collection and tell it to use Sql Server as a database provider
    services.AddDbContext&lt;MyDbContext&gt;(options =&gt;
        options.UseSqlServer(connection)
    );

    // Some other settings
}
</code></pre>
<p>Finally you can create the migrations and update the database</p>
<pre><code class="language-powershell">&gt; dotnet ef migrations add AddPersonModel
info: Microsoft.EntityFrameworkCore.Infrastructure[10403]
      Entity Framework Core 2.2.1-servicing-10028 initialized 'MyDbContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer' with options: None
Done. To undo this action, use 'ef migrations remove'
&gt; dotnet ef database update
info: Microsoft.EntityFrameworkCore.Infrastructure[10403]
      Entity Framework Core 2.2.1-servicing-10028 initialized 'MyDbContext' using provider 'Microsoft.EntityFrameworkCore.SqlServer' with options: None
info: Microsoft.EntityFrameworkCore.Database.Command[20101]
      Executed DbCommand (322ms) [Parameters=[], CommandType='Text', CommandTimeout='60']
      CREATE DATABASE [MyDatabase];
... Some more output
</code></pre>
<h2 id="dbinitializer">DbInitializer</h2>
<p>The responsibility of the <code>DbInitializer</code> class is to initialize data in the database.</p>
<pre><code class="language-csharp">public class DbInitializer
{
    public static void Initialize(MyDbContext context, IServiceProvider services)
    {
        // Get a logger
        var logger = services.GetRequiredService&lt;ILogger&lt;DbInitializer&gt;&gt;();

        // Make sure the database is created
        // We already did this in the previous step
        context.Database.EnsureCreated();

        if (context.Authors.Any())
        {
            logger.LogInformation(&quot;The database was already seeded&quot;);
            return;
        }

        logger.LogInformation(&quot;Start seeding the database.&quot;);

        var person = new Person
        {
            FirstName = &quot;Johan&quot;,
            LastName = &quot;Vergeer&quot;,
            Age = 32
        };

        context.People.Add(person);
        context.SaveChanges();

        logger.LogInformation(&quot;Finished seeding the database.&quot;);
    }
}
</code></pre>
<p>I think this is pretty self explanatory, but I'll add some explanation. The static <code>Initialize()</code> method takes a <code>MyDbContext</code> and an <code>IServiceProvider</code> instance as input parameters. We'll see in the next step how these are passed in. Especially in these setup methods I prefer to log too much over too little. They won't be called more then once in the lifetime of the application, so they won't clutter your log very much, and it gives us some insights that have proven to be very useful to me.</p>
<p>We just create one <code>Person</code> object, which is added to <code>MyDbContext</code>, after which <code>MyDbContext</code> saves the <code>Person</code> to the database.</p>
<h2 id="use-dbinitializer">Use DbInitializer</h2>
<p><code>DbInitializer</code> should run after the application has started, and before the user starts using it. Because we also want to be able to seed a database with other data while testing, the database can't be initialized in <code>Startup</code>. Therefore we put the initialization in the <code>Program</code> class, right after the host is built.</p>
<pre><code class="language-csharp">public class Program
{
    public static void Main(string[] args)
    {
        var host = CreateWebHostBuilder(args).Build();

        SeedDatabase(host);

        host.Run();
    }

    public static IWebHostBuilder CreateWebHostBuilder(string[] args) =&gt;
        WebHost.CreateDefaultBuilder(args)
            .UseStartup&lt;Startup&gt;();

    private static void SeedDatabase(IWebHost host)
    {
        using (var scope = host.Services.CreateScope())
        {
            var services = scope.ServiceProvider;
            try
            {
                var context = services.GetRequiredService&lt;MyDbContext&gt;();

                DbInitializer.Initialize(context, services);
            }
            catch (Exception ex)
            {
                var logger = services.GetRequiredService&lt;ILogger&lt;Program&gt;&gt;();
                logger.LogError(&quot;An error occurred while seeding the database&quot;);
            }
        }
    }
}
</code></pre>
<p>As you can see, we can get <code>MyDbContext</code> from the services collection because we already ran <code>Startup</code>.
Here we pass the <code>context</code> and the <code>IServiceProvider</code> instance, <code>services</code>, to the <code>Initialize()</code> method of <code>DbInitializer</code>, where
<code>context</code> is used to add and save the <code>Person</code> instance to the database, and <code>services</code> is used to get the <code>ILogger</code> instance.</p>
<h1 id="run-the-application">Run the application</h1>
<p>Now when we run the application for the first time, the data is seeded to the database.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'johanvergeer-github-io'; // required: replace example with your forum shortname
    var disqus_identifier = 'asp-net-core-seeding-databse';
    var disqus_title = 'ASP.NET Core seeding the database';
    var disqus_url = 'http://johanvergeer.github.io/posts/asp-net-core-seeding-databse';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
    </div>
</div>

    <footer class="footer footer-default">
    <div class="container">
      <nav class="float-left">
        <ul>
          <li>
            <a href="/">
              I'm Johan
            </a>
          </li>
        </ul>
      </nav>
      <div class="copyright float-right">
        ©
        <script>
          document.write(new Date().getFullYear())
        </script>, made with <i class="material-icons">favorite</i> by
        <a href="https://johanvergeer.github.io" target="_blank">Johan Vergeer</a>.
      </div>
    </div>
  </footer>
    <!--   Core JS Files   -->
<script src="../assets/js/core/jquery.min.js" type="text/javascript"></script>
<script src="../assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="../assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
<script src="../assets/js/plugins/moment.min.js"></script>
<!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
<script src="../assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
<script src="../assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
<!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
<script src="../assets/js/material-kit.js?v=2.0.5" type="text/javascript"></script>

<!-- Code highlighting -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/bash.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/cs.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/css.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/json.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/markdown.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/powershell.min.js"></script>
<script charset="UTF-8" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/yaml.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
</body>
</html>